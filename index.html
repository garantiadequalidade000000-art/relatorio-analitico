<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relat√≥rio Anal√≠tico de Atendimento</title>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            /* Light Theme Defaults */
            --primary-bg: #f0f2f5;
            --card-bg: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --accent-color: #3b82f6;
            --border-color: #e2e8f0;
            --input-bg: #f8fafc;
            --header-bg: #f8fafc;
            --chart-grid: #f1f5f9;
            --border-radius: 16px;
            --transition-speed: 0.3s;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        [data-theme="dark"] {
            --primary-bg: #0f172a;
            --card-bg: #1e293b;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --border-color: #334155;
            --input-bg: #020617;
            /* Darker than card */
            --header-bg: #1e293b;
            --chart-grid: #334155;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.5);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        }

        body {
            background-color: var(--primary-bg);
            font-family: 'Plus Jakarta Sans', sans-serif;
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
            padding-bottom: 40px;
        }

        /* Titles & Headings */
        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            color: var(--text-primary);
            font-weight: 700;
            letter-spacing: -0.025em;
        }

        /* Cards */
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            transition: transform var(--transition-speed), box-shadow var(--transition-speed);
        }

        .control-panel {
            position: sticky;
            top: 24px;
            border: none;
            box-shadow: var(--shadow-md);
            padding: 24px;
            border-radius: var(--border-radius);
            background: var(--card-bg);
            color: var(--text-primary);
        }

        /* Inputs */
        .form-control,
        .form-select {
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            padding: 10px 12px;
            font-size: 0.95rem;
            transition: all 0.2s;
            background-color: var(--input-bg);
            border-color: var(--border-color);
            color: var(--text-primary);
        }

        .form-control:focus,
        .form-select:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
            background-color: var(--card-bg);
            color: var(--text-primary);
        }

        label.fw-bold {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        /* Buttons */
        .btn {
            border-radius: 8px;
            font-weight: 600;
            padding: 10px 16px;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border: none;
            box-shadow: 0 4px 6px rgba(37, 99, 235, 0.2);
        }

        .btn-primary:hover {
            box-shadow: 0 6px 12px rgba(37, 99, 235, 0.3);
            transform: translateY(-1px);
        }

        .btn-dark {
            background: #1e293b;
            border: none;
        }

        /* Main Area */
        #captureArea {
            background: #fff;
            padding: 40px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            min-height: 80vh;
        }

        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f1f5f9;
        }

        .report-title h2 {
            font-size: 1.8rem;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .report-date {
            font-size: 0.9rem;
            color: var(--text-secondary);
            background: #f1f5f9;
            padding: 6px 12px;
            border-radius: 20px;
        }

        /* Charts */
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            /* Melhora para telas m√©dias */
            gap: 24px;
            margin-bottom: 48px;
        }

        .chart-card {
            background: var(--card-bg);
            padding: 16px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            height: 320px;
            position: relative;
            box-shadow: var(--shadow-sm);
            /* Importante para ChartJS flex√≠vel */
            width: 100%;
            overflow: hidden;
        }

        /* Entries / Tasks */
        .system-block {
            background: var(--card-bg);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 32px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
        }

        .system-header {
            background: var(--header-bg);
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .system-header h6 {
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tasks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            padding: 24px;
        }

        .task-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            position: relative;
            transition: all 0.2s;
            box-shadow: var(--shadow-sm);
            border-left: 4px solid transparent;
            /* Cor definida inline */
        }

        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .type-badge {
            font-size: 0.7rem;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 30px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #fff;
            display: inline-block;
            margin-bottom: 12px;
            vertical-align: middle;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .meta-info {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            color: #64748b;
            margin-bottom: 8px;
        }

        .meta-info i {
            font-size: 1rem;
        }

        .task-text {
            color: var(--text-primary);
            font-size: 0.95rem;
            line-height: 1.5;
        }

        /* Utility */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* AI Chatbot Styles - PREMIUM RE-DESIGN */
        .chat-trigger {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 1100;
            background: linear-gradient(135deg, var(--accent-color), #6366f1);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 50px;
            box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.4);
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chat-trigger:hover {
            transform: scale(1.05) translateY(-5px);
            box-shadow: 0 15px 30px -5px rgba(59, 130, 246, 0.6);
        }

        .chat-window {
            position: fixed;
            bottom: 6rem;
            right: 2rem;
            width: 420px;
            height: 600px;
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: 0 20px 50px -12px rgb(0 0 0 / 0.25);
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            z-index: 1100;
            opacity: 0;
            visibility: hidden;
            transform: translateY(30px) scale(0.95);
            transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
            overflow: hidden;
        }

        .chat-window.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
        }

        .chat-header {
            background: linear-gradient(135deg, var(--accent-color), #2563eb);
            color: white;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-tabs {
            background: rgba(0, 0, 0, 0.05);
            padding: 4px;
            display: flex;
            gap: 4px;
            border-bottom: 1px solid var(--border-color);
        }

        .chat-tab {
            flex: 1;
            padding: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-secondary);
        }

        .chat-tab.active {
            background: var(--card-bg);
            color: var(--accent-color);
            box-shadow: var(--shadow-sm);
        }

        .chat-messages {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
            background: linear-gradient(to bottom, transparent, rgba(59, 130, 246, 0.02));
        }

        .message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 0.9rem;
            line-height: 1.6;
            position: relative;
            animation: fadeIn 0.3s ease-out;
        }

        .message.system {
            background: var(--input-bg);
            color: var(--text-primary);
            align-self: flex-start;
            border-bottom-left-radius: 2px;
            box-shadow: var(--shadow-sm);
        }

        .message.user {
            background: var(--accent-color);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 2px;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }

        .chat-input-area {
            padding: 1.25rem;
            border-top: 1px solid var(--border-color);
            background: var(--card-bg);
        }

        .chat-settings {
            padding: 1.5rem;
            display: none;
            flex-direction: column;
            gap: 1rem;
            height: 100%;
            background: var(--card-bg);
            overflow-y: auto;
        }

        .chat-settings.active {
            display: flex;
        }

        .api-key-input {
            font-family: monospace;
            font-size: 0.8rem;
        }

        .typing-dots {
            display: inline-flex;
            gap: 4px;
        }

        .typing-dots span {
            width: 4px;
            height: 4px;
            background: var(--text-secondary);
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .typing-dots span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-dots span:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes bounce {

            0%,
            80%,
            100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1.0);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* =========================================
           PRINT / PDF EXPORT
           ========================================= */
        @media print {
            @page {
                size: A4 landscape;
                margin: 5mm;
            }

            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            body {
                background: white !important;
                padding: 0 !important;
            }

            .no-print {
                display: none !important;
            }

            .col-lg-9 {
                width: 100% !important;
                max-width: 100% !important;
                flex: 0 0 100% !important;
                padding: 0 !important;
            }

            #captureArea {
                box-shadow: none !important;
                padding: 10px !important;
                margin: 0 !important;
                border: none !important;
                max-width: 100% !important;
                min-height: auto !important;
                position: absolute;
                top: 0;
                left: 0;
                width: 100% !important;
            }

            /* Layout dos Gr√°ficos: Grid vira Flexbox para caber em uma linha */
            .charts-container {
                display: flex !important;
                flex-direction: row !important;
                justify-content: space-between !important;
                gap: 15px !important;
                height: 200px !important;
                margin-bottom: 20px !important;
                page-break-inside: avoid;
            }

            .chart-card {
                flex: 0 0 32% !important;
                width: 32% !important;
                height: 100% !important;
                border: 1px solid #ccc !important;
                box-shadow: none !important;
                margin: 0 !important;
                padding: 10px !important;
            }

            .chart-card canvas {
                width: 100% !important;
                height: 100% !important;
            }

            /* Ajuste de Texto */
            .tasks-grid {
                display: grid !important;
                grid-template-columns: 1fr 1fr !important;
                gap: 10px !important;
            }

            h2 {
                font-size: 1.6rem !important;
            }

            .badge {
                border: 1px solid #000;
                color: #000 !important;
            }
        }
    </style>
</head>

<body>

    <div class="container-fluid py-4">
        <div class="row g-4">
            <!-- Sidebar / Controls -->
            <div class="col-lg-3 no-print">
                <div class="control-panel">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="d-flex align-items-center text-primary">
                            <i class="bi bi-database-add fs-4 me-2"></i>
                            <h5 class="fw-bold m-0">Novo Registro</h5>
                        </div>
                        <button onclick="toggleTheme()" class="btn btn-sm btn-outline-secondary rounded-circle"
                            title="Alternar Tema">
                            <i id="themeIcon" class="bi bi-moon-stars-fill"></i>
                        </button>
                    </div>

                    <div class="mb-3">
                        <label class="small fw-bold">Sistema</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light border-end-0"><i class="bi bi-pc-display"></i></span>
                            <input type="text" id="systemInput" class="form-control border-start-0 ps-0"
                                placeholder="Ex: eSiscom">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="small fw-bold">Setor</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light border-end-0"><i class="bi bi-building"></i></span>
                            <select id="sectorInput" class="form-select border-start-0 ps-0">
                                <option value="Administrativo">üìÇ Administrativo</option>
                                <option value="Financeiro">üí∞ Financeiro</option>
                                <option value="Suporte">üéß Suporte</option>
                                <option value="Comercial">üìà Comercial</option>
                                <option value="Desenvolvimento">üíª Desenvolvimento</option>
                                <option value="T.I">üõ†Ô∏è T.I</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="small fw-bold">Solicitante</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light border-end-0"><i class="bi bi-person"></i></span>
                            <input type="text" id="userInput" class="form-control border-start-0 ps-0"
                                placeholder="Nome do solicitante">
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="small fw-bold">Detalhamento</label>
                        <textarea id="bulkInput" class="form-control" rows="5"
                            placeholder="Digite aqui... (Ex: ERRO: O sistema travou)"></textarea>
                        <div class="form-text text-muted small mt-1"><i class="bi bi-info-circle"></i> Comece com o TIPO
                            em mai√∫sculo para categorizar.</div>
                    </div>

                    <div class="d-grid gap-3">
                        <button onclick="addEntry()"
                            class="btn btn-primary d-flex align-items-center justify-content-center gap-2">
                            <i class="bi bi-plus-lg"></i> Lan√ßar Atendimento
                        </button>
                        <button onclick="safePrint()"
                            class="btn btn-outline-dark d-flex align-items-center justify-content-center gap-2">
                            <i class="bi bi-file-earmark-pdf"></i> Exportar PDF
                        </button>
                        <button onclick="resetData()" class="btn btn-link text-danger text-decoration-none btn-sm">
                            Limpar Todos os Dados
                        </button>
                    </div>

                    <div class="mt-4 pt-3 border-top text-center">
                        <small class="text-muted" style="font-size: 0.75rem;">&copy; 2026</small>
                    </div>
                </div>
            </div>

            <!-- Report Area -->
            <div class="col-lg-9">
                <div id="captureArea">
                    <div class="report-header">
                        <div class="report-title">
                            <h2 class="fw-bold"><i class="bi bi-clipboard-data me-2 text-primary"></i>
                                Relat√≥rio Anal√≠tico</h2>
                            <p class="text-muted m-0">Vis√£o geral dos atendimentos realizados</p>
                        </div>
                        <span class="report-date" id="dateDisplay">
                            <i class="bi bi-calendar3 me-1"></i> --/--/----
                        </span>
                    </div>

                    <div class="charts-container">
                        <div class="chart-card">
                            <canvas id="statusChart"></canvas>
                        </div>
                        <div class="chart-card">
                            <canvas id="sectorChart"></canvas>
                        </div>
                        <div class="chart-card">
                            <canvas id="userChart"></canvas>
                        </div>
                    </div>

                    <div id="content">
                        <div class="text-center py-5">
                            <img src="https://cdn-icons-png.flaticon.com/512/7486/7486777.png" width="120"
                                style="opacity: 0.5;" alt="Empty">
                            <p class="text-muted fs-5 mt-3">Aguardando novos registros...</p>
                            <small class="text-muted">Utilize o painel √† esquerda para adicionar dados.</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Chatbot Trigger -->
    <button class="chat-trigger no-print" onclick="toggleChat()" id="chatTrigger">
        <div class="position-relative">
            <i data-lucide="sparkles"></i>
            <span
                class="position-absolute top-0 start-100 translate-middle p-1 bg-success border border-light rounded-circle"></span>
        </div>
        <span>Assistente IA</span>
    </button>

    <!-- Chat Window -->
    <div class="chat-window no-print" id="chatWindow">
        <div class="chat-header">
            <div class="d-flex align-items-center gap-3">
                <div class="p-2 bg-white bg-opacity-25 rounded-circle">
                    <i data-lucide="bot" style="width: 20px;"></i>
                </div>
                <div>
                    <h6 class="m-0 fw-bold">Atendimento Insight AI <small class="fw-normal opacity-50">v1.4</small></h6>
                    <small class="opacity-75" id="aiStatus">Modo Local (Offline)</small>
                </div>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-sm btn-link text-white p-1" onclick="toggleSettings()" title="Configura√ß√µes">
                    <i data-lucide="settings" style="width: 18px;"></i>
                </button>
                <button class="btn-close btn-close-white" onclick="toggleChat()"></button>
            </div>
        </div>

        <!-- Tabs -->
        <div class="chat-tabs" id="chatTabs">
            <div class="chat-tab active" onclick="switchChatTab('chat')">Conversa</div>
            <div class="chat-tab" onclick="switchChatTab('settings')">Configura√ß√µes</div>
        </div>

        <!-- Chat Content -->
        <div class="chat-messages" id="chatMessages">
            <div class="message system">
                Ol√°! Sou seu assistente de atendimentos. Posso analisar seus relat√≥rios ou sugerir melhorias nos
                processos.
                <div class="mt-3 d-flex flex-wrap gap-2">
                    <button class="btn btn-sm btn-light border py-1 px-3 rounded-pill" onclick="askAICurrentReport()">
                        üìä Analisar Report
                    </button>
                    <button class="btn btn-sm btn-light border py-1 px-3 rounded-pill"
                        onclick="sendMessage('Como otimizar o suporte?')">
                        üí° Dicas de Processo
                    </button>
                </div>
            </div>
        </div>

        <!-- Settings Content -->
        <div class="chat-settings" id="chatSettings">
            <h6 class="fw-bold mb-3">Configura√ß√µes de IA</h6>
            <div class="mb-3">
                <label class="form-label small fw-bold">Provedor</label>
                <select class="form-select form-select-sm" id="aiProvider" onchange="updateProviderFields()">
                    <option value="local">Local (Sem API Key)</option>
                    <option value="openai">OpenAI (GPT-4o/3.5)</option>
                    <option value="gemini">Google Gemini</option>
                </select>
            </div>
            <div id="apiKeySection" style="display: none;">
                <div class="mb-3">
                    <label class="form-label small fw-bold">API Key</label>
                    <input type="password" id="apiKeyInput" class="form-control form-control-sm api-key-input"
                        placeholder="sk-...">
                </div>
                <div class="mb-3" id="modelSection">
                    <label class="form-label small fw-bold">Modelo</label>
                    <input type="text" id="apiModelInput" class="form-control form-control-sm" placeholder="gpt-4o">
                </div>
            </div>
            <div class="mt-auto p-3 bg-light rounded-3">
                <p class="small text-muted mb-2"><i data-lucide="info" style="width: 14px;"></i> Chaves seguras no local
                    storage.</p>
                <button class="btn btn-sm btn-outline-primary w-100" id="btnCheckModels" onclick="checkGeminiModels()"
                    style="font-size: 0.7rem;">
                    <i data-lucide="activity" style="width: 12px;"></i> Testar Conectividade
                </button>
                <div id="checkResult" class="small mt-2"
                    style="display:none; font-size: 0.65rem; max-height: 60px; overflow-y: auto;"></div>
            </div>
            <button class="btn btn-primary btn-sm mt-3" onclick="saveAISettings()">Salvar e Voltar</button>
        </div>

        <!-- Input Area -->
        <div class="chat-input-area" id="inputArea">
            <div class="input-group">
                <input type="text" id="chatInput" class="form-control border-0 bg-light"
                    placeholder="Envie uma mensagem..." onkeypress="handleChatKey(event)">
                <button class="btn btn-primary px-3" onclick="sendMessage()">
                    <i data-lucide="send" style="width: 18px;"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        let db = [];
        let typeColors = {
            "ERRO": "#ef4444",
            "D√öVIDA": "#f59e0b",
            "SOLICITA√á√ÉO": "#3b82f6",
            "MELHORIA": "#10b981",
            "OUTROS": "#8b5cf6"
        };
        const sectorIcons = {
            "Administrativo": "bi-briefcase",
            "Financeiro": "bi-cash-coin",
            "Suporte": "bi-headset",
            "Comercial": "bi-graph-up-arrow",
            "Desenvolvimento": "bi-code-slash",
            "T.I": "bi-motherboard"
        };

        let statusChart, sectorChart, userChart;

        // Cores modernas para fallback
        const palette = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#6366f1'];

        function getRandomColor(index) {
            return palette[index % palette.length];
        }

        function addEntry() {
            const system = document.getElementById('systemInput').value.trim() || "Geral";
            const sector = document.getElementById('sectorInput').value;
            const user = document.getElementById('userInput').value.trim() || "An√¥nimo";
            const rawText = document.getElementById('bulkInput').value;
            if (!rawText) {
                alert("Por favor, preencha o detalhamento.");
                return;
            }

            const matchType = rawText.match(/^([A-Z√Ä-√öa-z√†-√∫]+)/);
            // Tenta pegar a primeira palavra como tipo, sen√£o define Outros
            let type = matchType ? matchType[1].toUpperCase() : "OUTROS";
            // Limpa o texto (remove o tipo do come√ßo se achou)
            let cleanText = rawText;
            if (matchType) {
                cleanText = rawText.substring(matchType[0].length).replace(/^[:\s\-]+/, "");
            }

            // Se o tipo n√£o tem cor, pega do palette ou gera aleat√≥ria se acabar
            if (!typeColors[type]) {
                typeColors[type] = palette[Math.floor(Math.random() * palette.length)];
            }

            db.push({
                system,
                sector,
                user,
                type,
                text: cleanText || "Sem descri√ß√£o detalhada",
                color: typeColors[type],
                time: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
            });

            render();
            document.getElementById('bulkInput').value = "";
            document.getElementById('bulkInput').focus();
        }

        function render() {
            document.getElementById('dateDisplay').innerHTML = `<i class="bi bi-calendar3 me-1"></i> ${new Date().toLocaleDateString('pt-BR')}`;
            const content = document.getElementById('content');

            if (db.length === 0) {
                content.innerHTML = `
                <div class="text-center py-5">
                    <img src="https://cdn-icons-png.flaticon.com/512/7486/7486777.png" width="120" style="opacity: 0.5;" alt="Empty">
                    <p class="text-muted fs-5 mt-3">Aguardando novos registros...</p>
                </div>`;
                updateCharts();
                return;
            }

            content.innerHTML = "";
            // Agrupa por sistema
            const groups = db.reduce((acc, item) => {
                acc[item.system] = acc[item.system] || [];
                acc[item.system].push(item);
                return acc;
            }, {});

            for (const sys in groups) {
                const section = document.createElement('div');
                section.className = 'system-block';
                section.innerHTML = `
                <div class="system-header">
                    <h6 class="fw-bold m-0 text-primary"><i class="bi bi-laptop me-2"></i> ${sys}</h6>
                    <span class="badge bg-dark rounded-pill px-3">${groups[sys].length}</span>
                </div>
                <div class="tasks-grid">
                    ${groups[sys].map(item => `
                        <div class="task-card" style="border-left: 4px solid ${item.color}">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <span class="type-badge" style="background-color: ${item.color}">${item.type}</span>
                                <small class="text-muted">${item.time}</small>
                            </div>
                            <div class="meta-info">
                                <i class="bi bi-person-circle text-muted"></i>
                                <span class="fw-semibold text-primary">${item.user}</span>
                                <span class="text-muted mx-1">&bull;</span>
                                <i class="bi ${sectorIcons[item.sector] || 'bi-building'} text-muted"></i>
                                <span>${item.sector}</span>
                            </div>
                            <div class="task-text mt-2">${item.text}</div>
                        </div>
                    `).join('')}
                </div>`;
                content.appendChild(section);
            }
            updateCharts();
        }

        function initCharts() {
            // Configura√ß√£o global para fontes
            Chart.defaults.font.family = "'Plus Jakarta Sans', sans-serif";
            Chart.defaults.color = '#64748b';

            const commonOptions = (title) => ({
                maintainAspectRatio: false,
                responsive: true,
                indexAxis: 'y',
                plugins: {
                    title: {
                        display: true,
                        text: title,
                        font: { size: 14, weight: 600 },
                        padding: { bottom: 20 },
                        align: 'start'
                    },
                    legend: { display: false }
                },
                scales: {
                    x: { grid: { display: false }, ticks: { color: 'var(--text-secondary)' } },
                    y: { grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--chart-grid') }, ticks: { font: { weight: 500 }, color: 'var(--text-secondary)' } }
                },
                layout: { padding: 10 }
            });

            const ctxStatus = document.getElementById('statusChart').getContext('2d');
            statusChart = new Chart(ctxStatus, {
                type: 'doughnut',
                data: { labels: [], datasets: [{ data: [], borderWidth: 0 }] },
                options: {
                    maintainAspectRatio: false,
                    responsive: true,
                    cutout: '70%',
                    plugins: {
                        title: { display: true, text: 'Distribui√ß√£o por Tipo', font: { size: 14, weight: 600 }, align: 'start' },
                        legend: { position: 'right', labels: { usePointStyle: true, boxWidth: 8 } }
                    }
                }
            });

            const ctxSector = document.getElementById('sectorChart').getContext('2d');
            sectorChart = new Chart(ctxSector, {
                type: 'bar',
                data: { labels: [], datasets: [{ data: [], borderRadius: 4, barThickness: 20 }] },
                options: commonOptions('Por Setor')
            });

            const ctxUser = document.getElementById('userChart').getContext('2d');
            userChart = new Chart(ctxUser, {
                type: 'bar',
                data: { labels: [], datasets: [{ data: [], borderRadius: 4, barThickness: 20 }] },
                options: commonOptions('Por Solicitante')
            });
        }

        function updateCharts() {
            const typeMap = {}, sectorMap = {}, userMap = {};
            db.forEach(item => {
                typeMap[item.type] = (typeMap[item.type] || 0) + 1;
                sectorMap[item.sector] = (sectorMap[item.sector] || 0) + 1;
                userMap[item.user] = (userMap[item.user] || 0) + 1;
            });

            // Update Status Chart
            statusChart.data.labels = Object.keys(typeMap);
            statusChart.data.datasets[0].data = Object.values(typeMap);
            statusChart.data.datasets[0].backgroundColor = Object.keys(typeMap).map(t => typeColors[t] || '#cbd5e1');
            statusChart.update();

            // Update Sector Chart
            sectorChart.data.labels = Object.keys(sectorMap);
            sectorChart.data.datasets[0].data = Object.values(sectorMap);
            sectorChart.data.datasets[0].backgroundColor = '#3b82f6';
            sectorChart.update();

            // Update User Chart
            userChart.data.labels = Object.keys(userMap);
            userChart.data.datasets[0].data = Object.values(userMap);
            userChart.data.datasets[0].backgroundColor = '#8b5cf6';
            userChart.update();
        }

        function safePrint() {
            if (statusChart) statusChart.resize();
            if (sectorChart) sectorChart.resize();
            if (userChart) userChart.resize();

            setTimeout(() => {
                window.print();
            }, 500);
        }

        function resetData() {
            if (confirm("Tem certeza que deseja limpar todos os dados?")) {
                db = [];
                render();
            }
        }

        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);

            const icon = document.getElementById('themeIcon');
            if (newTheme === 'dark') {
                icon.className = 'bi bi-sun-fill';
            } else {
                icon.className = 'bi bi-moon-stars-fill';
            }

            // Atualizar gr√°ficos
            const gridColor = getComputedStyle(html).getPropertyValue('--chart-grid').trim();
            const textColor = getComputedStyle(html).getPropertyValue('--text-secondary').trim();

            Chart.defaults.color = textColor;
            Chart.defaults.borderColor = gridColor;

            [statusChart, sectorChart, userChart].forEach(chart => {
                if (chart) {
                    if (chart.options.scales.y) chart.options.scales.y.grid.color = gridColor;
                    chart.update();
                }
            });

            localStorage.setItem('theme', newTheme);
        }

        // Init Theme
        (function () {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
                document.getElementById('themeIcon').className = 'bi bi-sun-fill';
            }
        })();

        // AI Logic
        let AI_STATE = {
            provider: localStorage.getItem('atend-ai-provider') || 'local',
            key: localStorage.getItem('atend-ai-key') || '',
            model: localStorage.getItem('atend-ai-model') || 'gpt-4o',
            history: []
        };

        function toggleChat() {
            const chat = document.getElementById('chatWindow');
            chat.classList.toggle('active');
        }

        function toggleSettings() {
            const settings = document.getElementById('chatSettings');
            const messages = document.getElementById('chatMessages');
            const input = document.getElementById('inputArea');
            settings.classList.toggle('active');
            if (settings.classList.contains('active')) {
                messages.style.display = 'none';
                input.style.display = 'none';
                switchChatTab('settings');
            } else {
                messages.style.display = 'flex';
                input.style.display = 'block';
                switchChatTab('chat');
            }
        }

        function switchChatTab(tab) {
            const tabs = document.querySelectorAll('.chat-tab');
            tabs.forEach(t => t.classList.remove('active'));
            if (tab === 'chat') {
                tabs[0].classList.add('active');
                document.getElementById('chatSettings').classList.remove('active');
                document.getElementById('chatMessages').style.display = 'flex';
                document.getElementById('inputArea').style.display = 'block';
            } else {
                tabs[1].classList.add('active');
                document.getElementById('chatSettings').classList.add('active');
                document.getElementById('chatMessages').style.display = 'none';
                document.getElementById('inputArea').style.display = 'none';
            }
        }

        function updateProviderFields() {
            const provider = document.getElementById('aiProvider').value;
            const keySection = document.getElementById('apiKeySection');
            const modelSection = document.getElementById('modelSection');
            const modelInput = document.getElementById('apiModelInput');

            if (provider === 'local') {
                keySection.style.display = 'none';
            } else {
                keySection.style.display = 'block';
                modelSection.style.display = 'block';
                modelInput.placeholder = (provider === 'gemini') ? 'gemini-1.5-flash' : 'gpt-4o';
            }
        }

        function saveAISettings() {
            const provider = document.getElementById('aiProvider').value;
            const key = document.getElementById('apiKeyInput').value;
            const modelInput = document.getElementById('apiModelInput').value.trim();

            AI_STATE.provider = provider;
            AI_STATE.key = key;

            if (modelInput) {
                AI_STATE.model = modelInput;
            } else {
                AI_STATE.model = (provider === 'gemini') ? 'gemini-1.5-flash' : 'gpt-4o';
            }

            localStorage.setItem('atend-ai-provider', AI_STATE.provider);
            localStorage.setItem('atend-ai-key', AI_STATE.key);
            localStorage.setItem('atend-ai-model', AI_STATE.model);

            document.getElementById('aiStatus').innerText = AI_STATE.provider === 'local' ? 'Modo Local' : 'IA Cloud Ativa';
            toggleSettings();
        }

        function handleChatKey(e) {
            if (e.key === 'Enter') sendMessage();
        }

        function appendMessage(role, text) {
            const container = document.getElementById('chatMessages');
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${role}`;
            msgDiv.innerHTML = text;
            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
        }

        function getLocalResponse(text) {
            const lowText = text.toLowerCase();
            if (lowText.includes("analise") || lowText.includes("report") || lowText.includes("status")) {
                if (db.length === 0) return "Ainda n√£o h√° dados para analisar. Adicione registros no menu lateral! üöÄ";
                let total = db.length;
                let types = {};
                db.forEach(item => { types[item.type] = (types[item.type] || 0) + 1; });
                let typeSummary = Object.entries(types).map(([type, count]) => `‚Ä¢ ${type}: **${count}**`).join('\n');
                return `### üìä Insight Local (Atendimentos)\n\n` +
                    `‚Ä¢ Total de Registros: **${total}**\n` +
                    typeSummary + `\n\n` +
                    `Dica: Use uma API Key para an√°lise avan√ßada!`;
            }
            return "Ol√°! Estou em **Modo Local**. Posso processar estat√≠sticas do relat√≥rio. Para discuss√µes complexas, ative o modo **OpenAI** ou **Gemini**! ‚öôÔ∏è";
        }

        function formatAIResponse(text) {
            return text
                .replace(/^### (.*$)/gim, '<h6 class="fw-bold mt-3">$1</h6>')
                .replace(/^## (.*$)/gim, '<h5 class="fw-bold mt-3">$1</h5>')
                .replace(/^# (.*$)/gim, '<h4 class="fw-bold mt-3">$1</h4>')
                .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
                .replace(/\*(.*?)\*/g, '<i>$1</i>')
                .replace(/^\s*‚Ä¢ (.*$)/gim, '<div class="ms-3 mb-1">‚Ä¢ $1</div>')
                .replace(/\n/g, '<br>');
        }

        async function sendMessage(overrideText = null) {
            const input = document.getElementById('chatInput');
            const text = overrideText || input.value.trim();
            if (!text) return;

            if (!overrideText) input.value = '';
            appendMessage('user', text);

            const loadingId = 'loading-' + Date.now();
            appendMessage('system', `<div id="${loadingId}" class="typing-dots"><span></span><span></span><span></span></div>`);

            // Context Injection (Adaptado para a estrutura db)
            let fullPrompt = text;
            if (db.length > 0) {
                const summary = db.map(item => `[${item.type}] Sistema: ${item.system}, Setor: ${item.sector}, Usu√°rio: ${item.user}: ${item.text}`).join('\n');
                fullPrompt = `DADOS DO RELAT√ìRIO DE ATENDIMENTO:\n${summary}\n\nPERGUNTA: ${text}`;
            }

            try {
                const apiKey = AI_STATE.key ? AI_STATE.key.trim() : '';
                if (AI_STATE.provider === 'local' || !apiKey) {
                    throw new Error("USE_LOCAL");
                }

                let response;
                if (AI_STATE.provider === 'openai' || AI_STATE.provider === 'vercel') {
                    const url = AI_STATE.provider === 'vercel' ? "https://ai-gateway.vercel.sh/v1/chat/completions" : "https://api.openai.com/v1/chat/completions";
                    response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: AI_STATE.model || 'gpt-4o',
                            messages: [{ role: 'user', content: fullPrompt }],
                            temperature: 0.7
                        })
                    });
                } else if (AI_STATE.provider === 'gemini') {
                    // L√ìGICA DE AUTO-DESCOBERTA DO UNTITLED-2.HTML
                    const tryModels = [AI_STATE.model, 'gemini-1.5-flash', 'gemini-1.5-pro', 'gemini-pro'].filter(Boolean);
                    let lastErr = "";

                    for (let mName of tryModels) {
                        const mClean = mName.toLowerCase().trim().replace('models/', '');
                        try {
                            const url = `https://generativelanguage.googleapis.com/v1beta/models/${mClean}:generateContent?key=${apiKey}`;
                            response = await fetch(url, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ contents: [{ parts: [{ text: fullPrompt }] }] })
                            });
                            if (response.ok) break;
                            const eData = await response.json();
                            lastErr = eData.error?.message || `Erro ${response.status}`;
                        } catch (e) { lastErr = e.message; }
                    }

                    // TENTATIVA FINAL: DESCUBRA QUAIS MODELOS A CHAVE SUPORTA DINAMICAMENTE
                    if (!response || !response.ok) {
                        try {
                            const lRes = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
                            const lData = await lRes.json();
                            if (lData.models) {
                                const valid = lData.models.find(m => m.supportedGenerationMethods.includes('generateContent'))?.name;
                                if (valid) response = await fetch(`https://generativelanguage.googleapis.com/v1beta/${valid}:generateContent?key=${apiKey}`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ contents: [{ parts: [{ text: fullPrompt }] }] })
                                });
                            }
                        } catch (e) { }
                    }
                    if (!response || !response.ok) throw new Error(lastErr || "Chave sem modelos dispon√≠veis ou limite atingido.");
                }

                if (!response || !response.ok) {
                    const errData = await response.json().catch(() => ({}));
                    const errorMsg = errData.error?.message || `Erro ${response.status}`;
                    throw new Error(errorMsg);
                }

                const data = await response.json();
                let aiResponse = "";

                if (AI_STATE.provider === 'gemini') {
                    if (data.candidates && data.candidates[0]?.content?.parts?.[0]?.text) {
                        aiResponse = data.candidates[0].content.parts[0].text;
                    } else if (data.promptFeedback?.blockReason) {
                        throw new Error(`Bloqueado por seguran√ßa: ${data.promptFeedback.blockReason}`);
                    } else {
                        throw new Error("Resposta vazia da API Gemini.");
                    }
                } else {
                    aiResponse = data.choices[0].message.content;
                }

                const target = document.getElementById(loadingId);
                if (target) target.parentElement.innerHTML = formatAIResponse(aiResponse);

            } catch (err) {
                console.warn("Fallback Error:", err.message);
                setTimeout(() => {
                    const target = document.getElementById(loadingId);
                    if (!target) return;

                    if (err.message === "USE_LOCAL") {
                        target.parentElement.innerHTML = formatAIResponse(getLocalResponse(text));
                    } else {
                        target.parentElement.innerHTML = `<div class="p-2 border border-danger rounded mb-2 bg-danger bg-opacity-10" style="font-size: 0.8rem;">
                            <b class="text-danger">Erro na API Cloud:</b><br>
                            ${err.message}<br>
                            <span class="text-muted small">Dica: Verifique se sua chave tem permiss√£o para o modelo selecionado. Tentamos a auto-corre√ß√£o, mas o erro persistiu.</span>
                        </div>` + formatAIResponse(getLocalResponse(text));
                    }
                }, 800);
            }
        }

        function askAICurrentReport() {
            sendMessage("Analise meu relat√≥rio atual e me d√™ um feedback sobre os atendimentos realizados.");
        }

        async function checkGeminiModels() {
            const key = document.getElementById('apiKeyInput').value.trim();
            const resDiv = document.getElementById('checkResult');
            if (!key) return alert("Insira uma chave primeiro.");
            resDiv.style.display = 'block';
            resDiv.innerHTML = "Checando...";
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
                const data = await response.json();
                if (!response.ok) throw new Error(data.error?.message || "Erro desconhecido");
                const models = data.models.map(m => m.name.split('/').pop());
                resDiv.innerHTML = `<span class="text-success">‚úÖ Conectado!</span><br>Modelos: ${models.slice(0, 5).join(', ')}...`;
            } catch (err) {
                resDiv.innerHTML = `<span class="text-danger">‚ùå Erro:</span> ${err.message}`;
            }
        }

        function initChatUI() {
            const provEl = document.getElementById('aiProvider');
            const keyEl = document.getElementById('apiKeyInput');
            const modEl = document.getElementById('apiModelInput');
            if (provEl) provEl.value = AI_STATE.provider;
            if (keyEl) keyEl.value = AI_STATE.key;
            if (modEl) modEl.value = AI_STATE.model;
            document.getElementById('aiStatus').innerText = AI_STATE.provider === 'local' ? 'Modo Local' : 'IA Cloud Ativa';
            updateProviderFields();
            lucide.createIcons();
        }

        window.onload = () => {
            initCharts();
            initChatUI();
        };
    </script>
</body>

</html>
