<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relat√≥rio Anal√≠tico de Atendimento</title>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            /* Light Theme Defaults */
            --primary-bg: #f0f2f5;
            --card-bg: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --accent-color: #3b82f6;
            --border-color: #e2e8f0;
            --input-bg: #f8fafc;
            --header-bg: #f8fafc;
            --chart-grid: #f1f5f9;
            --border-radius: 16px;
            --transition-speed: 0.3s;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        [data-theme="dark"] {
            --primary-bg: #0f172a;
            --card-bg: #1e293b;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --border-color: #334155;
            --input-bg: #020617;
            /* Darker than card */
            --header-bg: #1e293b;
            --chart-grid: #334155;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.5);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        }

        body {
            background-color: var(--primary-bg);
            font-family: 'Plus Jakarta Sans', sans-serif;
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
            padding-bottom: 40px;
        }

        /* Titles & Headings */
        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            color: var(--text-primary);
            font-weight: 700;
            letter-spacing: -0.025em;
        }

        /* Cards */
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            transition: transform var(--transition-speed), box-shadow var(--transition-speed);
        }

        .control-panel {
            position: sticky;
            top: 24px;
            border: none;
            box-shadow: var(--shadow-md);
            padding: 24px;
            border-radius: var(--border-radius);
            background: var(--card-bg);
            color: var(--text-primary);
        }

        /* Inputs */
        .form-control,
        .form-select {
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            padding: 10px 12px;
            font-size: 0.95rem;
            transition: all 0.2s;
            background-color: var(--input-bg);
            border-color: var(--border-color);
            color: var(--text-primary);
        }

        .form-control:focus,
        .form-select:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
            background-color: var(--card-bg);
            color: var(--text-primary);
        }

        label.fw-bold {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        /* Buttons */
        .btn {
            border-radius: 8px;
            font-weight: 600;
            padding: 10px 16px;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border: none;
            box-shadow: 0 4px 6px rgba(37, 99, 235, 0.2);
        }

        .btn-primary:hover {
            box-shadow: 0 6px 12px rgba(37, 99, 235, 0.3);
            transform: translateY(-1px);
        }

        .btn-dark {
            background: #1e293b;
            border: none;
        }

        /* Main Area */
        #captureArea {
            background: #fff;
            padding: 40px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            min-height: 80vh;
        }

        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f1f5f9;
        }

        .report-title h2 {
            font-size: 1.8rem;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .report-date {
            font-size: 0.9rem;
            color: var(--text-secondary);
            background: #f1f5f9;
            padding: 6px 12px;
            border-radius: 20px;
        }

        /* Charts */
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            /* Melhora para telas m√©dias */
            gap: 24px;
            margin-bottom: 48px;
        }

        .chart-card {
            background: var(--card-bg);
            padding: 16px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            height: 320px;
            position: relative;
            box-shadow: var(--shadow-sm);
            /* Importante para ChartJS flex√≠vel */
            width: 100%;
            overflow: hidden;
        }

        /* Entries / Tasks */
        .system-block {
            background: var(--card-bg);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 32px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
        }

        .system-header {
            background: var(--header-bg);
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .system-header h6 {
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tasks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            padding: 24px;
        }

        .task-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            position: relative;
            transition: all 0.2s;
            box-shadow: var(--shadow-sm);
            border-left: 4px solid transparent;
            /* Cor definida inline */
        }

        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .type-badge {
            font-size: 0.7rem;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 30px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #fff;
            display: inline-block;
            margin-bottom: 12px;
            vertical-align: middle;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .meta-info {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            color: #64748b;
            margin-bottom: 8px;
        }

        .meta-info i {
            font-size: 1rem;
        }

        .task-text {
            color: var(--text-primary);
            font-size: 0.95rem;
            line-height: 1.5;
        }

        /* Utility */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* =========================================
           PRINT / PDF EXPORT
           ========================================= */
        @media print {
            @page {
                size: A4 landscape;
                margin: 5mm;
            }

            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            body {
                background: white !important;
                padding: 0 !important;
            }

            .no-print {
                display: none !important;
            }

            .col-lg-9 {
                width: 100% !important;
                max-width: 100% !important;
                flex: 0 0 100% !important;
                padding: 0 !important;
            }

            #captureArea {
                box-shadow: none !important;
                padding: 10px !important;
                margin: 0 !important;
                border: none !important;
                max-width: 100% !important;
                min-height: auto !important;
                position: absolute;
                top: 0;
                left: 0;
                width: 100% !important;
            }

            /* Layout dos Gr√°ficos: Grid vira Flexbox para caber em uma linha */
            .charts-container {
                display: flex !important;
                flex-direction: row !important;
                justify-content: space-between !important;
                gap: 15px !important;
                height: 200px !important;
                margin-bottom: 20px !important;
                page-break-inside: avoid;
            }

            .chart-card {
                flex: 0 0 32% !important;
                width: 32% !important;
                height: 100% !important;
                border: 1px solid #ccc !important;
                box-shadow: none !important;
                margin: 0 !important;
                padding: 10px !important;
            }

            .chart-card canvas {
                width: 100% !important;
                height: 100% !important;
            }

            /* Ajuste de Texto */
            .tasks-grid {
                display: grid !important;
                grid-template-columns: 1fr 1fr !important;
                gap: 10px !important;
            }

            h2 {
                font-size: 1.6rem !important;
            }

            .badge {
                border: 1px solid #000;
                color: #000 !important;
            }
        }
    </style>
</head>

<body>

    <div class="container-fluid py-4">
        <div class="row g-4">
            <!-- Sidebar / Controls -->
            <div class="col-lg-3 no-print">
                <div class="control-panel">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="d-flex align-items-center text-primary">
                            <i class="bi bi-database-add fs-4 me-2"></i>
                            <h5 class="fw-bold m-0">Novo Registro</h5>
                        </div>
                        <button onclick="toggleTheme()" class="btn btn-sm btn-outline-secondary rounded-circle"
                            title="Alternar Tema">
                            <i id="themeIcon" class="bi bi-moon-stars-fill"></i>
                        </button>
                    </div>

                    <div class="mb-3">
                        <label class="small fw-bold">Sistema</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light border-end-0"><i class="bi bi-pc-display"></i></span>
                            <input type="text" id="systemInput" class="form-control border-start-0 ps-0"
                                placeholder="Ex: eSiscom">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="small fw-bold">Setor</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light border-end-0"><i class="bi bi-building"></i></span>
                            <select id="sectorInput" class="form-select border-start-0 ps-0">
                                <option value="Administrativo">üìÇ Administrativo</option>
                                <option value="Financeiro">üí∞ Financeiro</option>
                                <option value="Suporte">üéß Suporte</option>
                                <option value="Comercial">üìà Comercial</option>
                                <option value="Desenvolvimento">üíª Desenvolvimento</option>
                                <option value="T.I">üõ†Ô∏è T.I</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="small fw-bold">Solicitante</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light border-end-0"><i class="bi bi-person"></i></span>
                            <input type="text" id="userInput" class="form-control border-start-0 ps-0"
                                placeholder="Nome do solicitante">
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="small fw-bold">Detalhamento</label>
                        <textarea id="bulkInput" class="form-control" rows="5"
                            placeholder="Digite aqui... (Ex: ERRO: O sistema travou)"></textarea>
                        <div class="form-text text-muted small mt-1"><i class="bi bi-info-circle"></i> Comece com o TIPO
                            em mai√∫sculo para categorizar.</div>
                    </div>

                    <div class="d-grid gap-3">
                        <button onclick="addEntry()"
                            class="btn btn-primary d-flex align-items-center justify-content-center gap-2">
                            <i class="bi bi-plus-lg"></i> Lan√ßar Atendimento
                        </button>
                        <button onclick="safePrint()"
                            class="btn btn-outline-dark d-flex align-items-center justify-content-center gap-2">
                            <i class="bi bi-file-earmark-pdf"></i> Exportar PDF
                        </button>
                        <button onclick="resetData()" class="btn btn-link text-danger text-decoration-none btn-sm">
                            Limpar Todos os Dados
                        </button>
                    </div>

                    <div class="mt-4 pt-3 border-top text-center">
                        <small class="text-muted" style="font-size: 0.75rem;">Powered by Antigravity &copy; 2026</small>
                    </div>
                </div>
            </div>

            <!-- Report Area -->
            <div class="col-lg-9">
                <div id="captureArea">
                    <div class="report-header">
                        <div class="report-title">
                            <h2 class="fw-bold"><i class="bi bi-clipboard-data me-2 text-primary"></i>
                                Relat√≥rio Anal√≠tico</h2>
                            <p class="text-muted m-0">Vis√£o geral dos atendimentos realizados</p>
                        </div>
                        <span class="report-date" id="dateDisplay">
                            <i class="bi bi-calendar3 me-1"></i> --/--/----
                        </span>
                    </div>

                    <div class="charts-container">
                        <div class="chart-card">
                            <canvas id="statusChart"></canvas>
                        </div>
                        <div class="chart-card">
                            <canvas id="sectorChart"></canvas>
                        </div>
                        <div class="chart-card">
                            <canvas id="userChart"></canvas>
                        </div>
                    </div>

                    <div id="content">
                        <div class="text-center py-5">
                            <img src="https://cdn-icons-png.flaticon.com/512/7486/7486777.png" width="120"
                                style="opacity: 0.5;" alt="Empty">
                            <p class="text-muted fs-5 mt-3">Aguardando novos registros...</p>
                            <small class="text-muted">Utilize o painel √† esquerda para adicionar dados.</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let db = [];
        let typeColors = {
            "ERRO": "#ef4444",
            "D√öVIDA": "#f59e0b",
            "SOLICITA√á√ÉO": "#3b82f6",
            "MELHORIA": "#10b981",
            "OUTROS": "#8b5cf6"
        };
        const sectorIcons = {
            "Administrativo": "bi-briefcase",
            "Financeiro": "bi-cash-coin",
            "Suporte": "bi-headset",
            "Comercial": "bi-graph-up-arrow",
            "Desenvolvimento": "bi-code-slash",
            "T.I": "bi-motherboard"
        };

        let statusChart, sectorChart, userChart;

        // Cores modernas para fallback
        const palette = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#6366f1'];

        function getRandomColor(index) {
            return palette[index % palette.length];
        }

        function addEntry() {
            const system = document.getElementById('systemInput').value.trim() || "Geral";
            const sector = document.getElementById('sectorInput').value;
            const user = document.getElementById('userInput').value.trim() || "An√¥nimo";
            const rawText = document.getElementById('bulkInput').value;
            if (!rawText) {
                alert("Por favor, preencha o detalhamento.");
                return;
            }

            const matchType = rawText.match(/^([A-Z√Ä-√öa-z√†-√∫]+)/);
            // Tenta pegar a primeira palavra como tipo, sen√£o define Outros
            let type = matchType ? matchType[1].toUpperCase() : "OUTROS";
            // Limpa o texto (remove o tipo do come√ßo se achou)
            let cleanText = rawText;
            if (matchType) {
                cleanText = rawText.substring(matchType[0].length).replace(/^[:\s\-]+/, "");
            }

            // Se o tipo n√£o tem cor, pega do palette ou gera aleat√≥ria se acabar
            if (!typeColors[type]) {
                typeColors[type] = palette[Math.floor(Math.random() * palette.length)];
            }

            db.push({
                system,
                sector,
                user,
                type,
                text: cleanText || "Sem descri√ß√£o detalhada",
                color: typeColors[type],
                time: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
            });

            render();
            document.getElementById('bulkInput').value = "";
            document.getElementById('bulkInput').focus();
        }

        function render() {
            document.getElementById('dateDisplay').innerHTML = `<i class="bi bi-calendar3 me-1"></i> ${new Date().toLocaleDateString('pt-BR')}`;
            const content = document.getElementById('content');

            if (db.length === 0) {
                content.innerHTML = `
                <div class="text-center py-5">
                    <img src="https://cdn-icons-png.flaticon.com/512/7486/7486777.png" width="120" style="opacity: 0.5;" alt="Empty">
                    <p class="text-muted fs-5 mt-3">Aguardando novos registros...</p>
                </div>`;
                updateCharts();
                return;
            }

            content.innerHTML = "";
            // Agrupa por sistema
            const groups = db.reduce((acc, item) => {
                acc[item.system] = acc[item.system] || [];
                acc[item.system].push(item);
                return acc;
            }, {});

            for (const sys in groups) {
                const section = document.createElement('div');
                section.className = 'system-block';
                section.innerHTML = `
                <div class="system-header">
                    <h6 class="fw-bold m-0 text-primary"><i class="bi bi-laptop me-2"></i> ${sys}</h6>
                    <span class="badge bg-dark rounded-pill px-3">${groups[sys].length}</span>
                </div>
                <div class="tasks-grid">
                    ${groups[sys].map(item => `
                        <div class="task-card" style="border-left: 4px solid ${item.color}">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <span class="type-badge" style="background-color: ${item.color}">${item.type}</span>
                                <small class="text-muted">${item.time}</small>
                            </div>
                            <div class="meta-info">
                                <i class="bi bi-person-circle text-muted"></i>
                                <span class="fw-semibold text-primary">${item.user}</span>
                                <span class="text-muted mx-1">&bull;</span>
                                <i class="bi ${sectorIcons[item.sector] || 'bi-building'} text-muted"></i>
                                <span>${item.sector}</span>
                            </div>
                            <div class="task-text mt-2">${item.text}</div>
                        </div>
                    `).join('')}
                </div>`;
                content.appendChild(section);
            }
            updateCharts();
        }

        function initCharts() {
            // Configura√ß√£o global para fontes
            Chart.defaults.font.family = "'Plus Jakarta Sans', sans-serif";
            Chart.defaults.color = '#64748b';

            const commonOptions = (title) => ({
                maintainAspectRatio: false,
                responsive: true,
                indexAxis: 'y',
                plugins: {
                    title: {
                        display: true,
                        text: title,
                        font: { size: 14, weight: 600 },
                        padding: { bottom: 20 },
                        align: 'start'
                    },
                    legend: { display: false }
                },
                scales: {
                    x: { grid: { display: false }, ticks: { color: 'var(--text-secondary)' } },
                    y: { grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--chart-grid') }, ticks: { font: { weight: 500 }, color: 'var(--text-secondary)' } }
                },
                layout: { padding: 10 }
            });

            const ctxStatus = document.getElementById('statusChart').getContext('2d');
            statusChart = new Chart(ctxStatus, {
                type: 'doughnut',
                data: { labels: [], datasets: [{ data: [], borderWidth: 0 }] },
                options: {
                    maintainAspectRatio: false,
                    responsive: true,
                    cutout: '70%',
                    plugins: {
                        title: { display: true, text: 'Distribui√ß√£o por Tipo', font: { size: 14, weight: 600 }, align: 'start' },
                        legend: { position: 'right', labels: { usePointStyle: true, boxWidth: 8 } }
                    }
                }
            });

            const ctxSector = document.getElementById('sectorChart').getContext('2d');
            sectorChart = new Chart(ctxSector, {
                type: 'bar',
                data: { labels: [], datasets: [{ data: [], borderRadius: 4, barThickness: 20 }] },
                options: commonOptions('Por Setor')
            });

            const ctxUser = document.getElementById('userChart').getContext('2d');
            userChart = new Chart(ctxUser, {
                type: 'bar',
                data: { labels: [], datasets: [{ data: [], borderRadius: 4, barThickness: 20 }] },
                options: commonOptions('Por Solicitante')
            });
        }

        function updateCharts() {
            const typeMap = {}, sectorMap = {}, userMap = {};
            db.forEach(item => {
                typeMap[item.type] = (typeMap[item.type] || 0) + 1;
                sectorMap[item.sector] = (sectorMap[item.sector] || 0) + 1;
                userMap[item.user] = (userMap[item.user] || 0) + 1;
            });

            // Update Status Chart
            statusChart.data.labels = Object.keys(typeMap);
            statusChart.data.datasets[0].data = Object.values(typeMap);
            statusChart.data.datasets[0].backgroundColor = Object.keys(typeMap).map(t => typeColors[t] || '#cbd5e1');
            statusChart.update();

            // Update Sector Chart
            sectorChart.data.labels = Object.keys(sectorMap);
            sectorChart.data.datasets[0].data = Object.values(sectorMap);
            sectorChart.data.datasets[0].backgroundColor = '#3b82f6';
            sectorChart.update();

            // Update User Chart
            userChart.data.labels = Object.keys(userMap);
            userChart.data.datasets[0].data = Object.values(userMap);
            userChart.data.datasets[0].backgroundColor = '#8b5cf6';
            userChart.update();
        }

        function safePrint() {
            if (statusChart) statusChart.resize();
            if (sectorChart) sectorChart.resize();
            if (userChart) userChart.resize();

            setTimeout(() => {
                window.print();
            }, 500);
        }

        function resetData() {
            if (confirm("Tem certeza que deseja limpar todos os dados?")) {
                db = [];
                render();
            }
        }

        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);

            const icon = document.getElementById('themeIcon');
            if (newTheme === 'dark') {
                icon.className = 'bi bi-sun-fill';
            } else {
                icon.className = 'bi bi-moon-stars-fill';
            }

            // Atualizar gr√°ficos
            const gridColor = getComputedStyle(html).getPropertyValue('--chart-grid').trim();
            const textColor = getComputedStyle(html).getPropertyValue('--text-secondary').trim();

            Chart.defaults.color = textColor;
            Chart.defaults.borderColor = gridColor;

            [statusChart, sectorChart, userChart].forEach(chart => {
                if (chart) {
                    if (chart.options.scales.y) chart.options.scales.y.grid.color = gridColor;
                    chart.update();
                }
            });

            localStorage.setItem('theme', newTheme);
        }

        // Init Theme
        (function () {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
                document.getElementById('themeIcon').className = 'bi bi-sun-fill';
            }
        })();

        window.onload = initCharts;
    </script>
</body>

</html>
